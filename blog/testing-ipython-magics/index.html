<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to Test IPython Magic | Peter Baumgartner</title><meta name=keywords content><meta name=description content="TL;DR If you want to test ipython magics you can do the following:
Import the global ipython app with from IPython.testing.globalipapp import get_ipython Crete an object with the global ipython app with ip = get_ipython() Load your magic with ip.magic('load_ext your_magic_name') Run your magic with ip.run_line_magic('your_magic_function', 'your_magic_arguments') (Optional) Access results of your magic with ip.user_ns (ipython user namespace). An example test using pytest looks like this:
import pytest from IPython.testing.globalipapp import get_ipython ip = get_ipython() ip."><meta name=author content><link rel=canonical href=https://www.peterbaumgartner.com/blog/testing-ipython-magics/><link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.peterbaumgartner.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.peterbaumgartner.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.peterbaumgartner.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.peterbaumgartner.com/apple-touch-icon.png><link rel=mask-icon href=https://www.peterbaumgartner.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.105.0"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-72692144-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="How to Test IPython Magic"><meta property="og:description" content="TL;DR If you want to test ipython magics you can do the following:
Import the global ipython app with from IPython.testing.globalipapp import get_ipython Crete an object with the global ipython app with ip = get_ipython() Load your magic with ip.magic('load_ext your_magic_name') Run your magic with ip.run_line_magic('your_magic_function', 'your_magic_arguments') (Optional) Access results of your magic with ip.user_ns (ipython user namespace). An example test using pytest looks like this:
import pytest from IPython.testing.globalipapp import get_ipython ip = get_ipython() ip."><meta property="og:type" content="article"><meta property="og:url" content="https://www.peterbaumgartner.com/blog/testing-ipython-magics/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2018-02-16T00:00:00+00:00"><meta property="article:modified_time" content="2018-02-16T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to Test IPython Magic"><meta name=twitter:description content="TL;DR If you want to test ipython magics you can do the following:
Import the global ipython app with from IPython.testing.globalipapp import get_ipython Crete an object with the global ipython app with ip = get_ipython() Load your magic with ip.magic('load_ext your_magic_name') Run your magic with ip.run_line_magic('your_magic_function', 'your_magic_arguments') (Optional) Access results of your magic with ip.user_ns (ipython user namespace). An example test using pytest looks like this:
import pytest from IPython.testing.globalipapp import get_ipython ip = get_ipython() ip."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://www.peterbaumgartner.com/blog/"},{"@type":"ListItem","position":2,"name":"How to Test IPython Magic","item":"https://www.peterbaumgartner.com/blog/testing-ipython-magics/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to Test IPython Magic","name":"How to Test IPython Magic","description":"TL;DR If you want to test ipython magics you can do the following:\nImport the global ipython app with from IPython.testing.globalipapp import get_ipython Crete an object with the global ipython app with ip = get_ipython() Load your magic with ip.magic('load_ext your_magic_name') Run your magic with ip.run_line_magic('your_magic_function', 'your_magic_arguments') (Optional) Access results of your magic with ip.user_ns (ipython user namespace). An example test using pytest looks like this:\nimport pytest from IPython.testing.globalipapp import get_ipython ip = get_ipython() ip.","keywords":[],"articleBody":"TL;DR If you want to test ipython magics you can do the following:\nImport the global ipython app with from IPython.testing.globalipapp import get_ipython Crete an object with the global ipython app with ip = get_ipython() Load your magic with ip.magic('load_ext your_magic_name') Run your magic with ip.run_line_magic('your_magic_function', 'your_magic_arguments') (Optional) Access results of your magic with ip.user_ns (ipython user namespace). An example test using pytest looks like this:\nimport pytest from IPython.testing.globalipapp import get_ipython ip = get_ipython() ip.magic('load_ext excelify') def test_nonexistent_object(): with pytest.raises(NameError): ip.run_line_magic('excel', 'nonexistentobject') More Details Background IPython Magics are a nice way to apply command-line like behavior from within an ipython kernel or jupyter notebook. Several magics come built-in (%%time is my favorite), and it’s also possible to write your own magics to help with common tasks.\nI ventured into the business of writing a custom magic by creating one that helped export pandas objects into Excel files. The idea emerged as I was running through a notebook where I needed to document a bunch of intermediate data frames, and rather than save them until the end of the notebook and loop through them to export, I figured a magic might be a nice way to handle this export within a cell.\nI’ve been working on testing my code more and I figured this was a good project to continue practicing. I understood how to write basic tests that excecuted python code, but running a magic to test present an intersting case. In an ipython shell, magics are prepended with a % and work as expected, but if you type a magic into a regular python shell, it’ll give you a SyntaxError.\nLuckily, ipython itself is well tested and they provide access to a shell object that you can send commands to. However, the documentation around how to use this to actually write tests is patchy. I pieced together my understanding from going through the tests for the standard magics as well as the tests for the rpy2 magics.\nExample Detail First, we use the get_ipython method to get a global ipython object. If you actually run this first line in a standard python shell, you’ll see something interesting:\n\u003e\u003e\u003e from IPython.testing.globalipapp import get_ipython \u003e\u003e\u003e ip = get_ipython() In : This will both create a shell object that you can reference with ip as well as turn that standard python shell into an ipython shell.\nSecond, we load the magic with ip.magic('load_ext excelify'). The .magic() method basically does the of prepending the argument provided with a % if you were in an ipython shell.\nThird, we use the run_line_magic() method on the ip object to run our line magic. This method takes two arguments: the name of the magic function and the remaining of the arguments for that magic. If you were in an ipython shell, this is the equivalent of running %{magic name} {magic arguments}. Note: We can also load in your extension by running ip.run_line_magic('load_ext', 'excelify') instead of using the magic() method.\nNow that we’ve put all those parts together, we can use these methods to write more tests. There are other related methods if you’re testing magics that might be helpful, including:\nrun_cell_magic(magic_name, magic_args, cell) run_line_magic(magic_name, magic_args) magic(magic_line) Potential Gotcha: If you want to run a magic that doesn’t take any arguments, you’ll need to pass an empty string for magic_args in the methods above (rather than leave the argument empty or None)\n","wordCount":"566","inLanguage":"en","datePublished":"2018-02-16T00:00:00Z","dateModified":"2018-02-16T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.peterbaumgartner.com/blog/testing-ipython-magics/"},"publisher":{"@type":"Organization","name":"Peter Baumgartner","logo":{"@type":"ImageObject","url":"https://www.peterbaumgartner.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.peterbaumgartner.com/ accesskey=h title="Peter Baumgartner (Alt + H)">Peter Baumgartner</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://www.peterbaumgartner.com/ title=Home><span>Home</span></a></li><li><a href=https://www.peterbaumgartner.com/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://www.peterbaumgartner.com/notebooks/ title=Notebooks><span>Notebooks</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>How to Test IPython Magic</h1><div class=post-meta><span title='2018-02-16 00:00:00 +0000 UTC'>February 16, 2018</span></div></header><div class=post-content><h2 id=tldr>TL;DR<a hidden class=anchor aria-hidden=true href=#tldr>#</a></h2><p>If you want to test <code>ipython magics</code> you can do the following:</p><ol><li>Import the global ipython app with <code>from IPython.testing.globalipapp import get_ipython</code></li><li>Crete an object with the global ipython app with <code>ip = get_ipython()</code></li><li>Load your magic with <code>ip.magic('load_ext your_magic_name')</code></li><li>Run your magic with <code>ip.run_line_magic('your_magic_function', 'your_magic_arguments')</code></li><li>(Optional) Access results of your magic with <code>ip.user_ns</code> (ipython user namespace).</li></ol><p>An example test using pytest looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> pytest
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> IPython.testing.globalipapp <span style=color:#f92672>import</span> get_ipython
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ip <span style=color:#f92672>=</span> get_ipython()
</span></span><span style=display:flex><span>ip<span style=color:#f92672>.</span>magic(<span style=color:#e6db74>&#39;load_ext excelify&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_nonexistent_object</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> pytest<span style=color:#f92672>.</span>raises(<span style=color:#a6e22e>NameError</span>):
</span></span><span style=display:flex><span>        ip<span style=color:#f92672>.</span>run_line_magic(<span style=color:#e6db74>&#39;excel&#39;</span>, <span style=color:#e6db74>&#39;nonexistentobject&#39;</span>)
</span></span></code></pre></div><h2 id=more-details>More Details<a hidden class=anchor aria-hidden=true href=#more-details>#</a></h2><h3 id=background>Background<a hidden class=anchor aria-hidden=true href=#background>#</a></h3><p>IPython Magics are a nice way to apply command-line like behavior from within an ipython kernel or jupyter notebook. Several magics come built-in (<code>%%time</code> is my favorite), and it&rsquo;s also possible to write your own magics to help with common tasks.</p><p>I ventured into the business of writing a custom magic by creating one that helped export pandas objects into Excel files. The idea emerged as I was running through a notebook where I needed to document a bunch of intermediate data frames, and rather than save them until the end of the notebook and loop through them to export, I figured a magic might be a nice way to handle this export within a cell.</p><p>I&rsquo;ve been working on testing my code more and I figured this was a good project to continue practicing. I understood how to write basic tests that excecuted python code, but running a magic to test present an intersting case. In an ipython shell, magics are prepended with a <code>%</code> and work as expected, but if you type a magic into a regular python shell, it&rsquo;ll give you a <code>SyntaxError</code>.</p><p>Luckily, ipython itself is well tested and they provide access to a shell object that you can send commands to. However, the documentation around how to use this to actually write tests is patchy. I pieced together my understanding from going through the tests for the <a href="https://bitbucket.org/rpy2/rpy2/src/d5d60e9a0f684c27015fa29c26bbb7fd75863bc2/rpy/ipython/tests/test_rmagic.py?at=default&fileviewer=file-view-default">standard magics</a> as well as the tests for the <a href="https://bitbucket.org/rpy2/rpy2/src/d5d60e9a0f684c27015fa29c26bbb7fd75863bc2/rpy/ipython/tests/test_rmagic.py?at=default&fileviewer=file-view-default">rpy2 magics</a>.</p><h3 id=example-detail>Example Detail<a hidden class=anchor aria-hidden=true href=#example-detail>#</a></h3><p>First, we use the <code>get_ipython</code> method to get a global ipython object. If you actually run this first line in a standard python shell, you&rsquo;ll see something interesting:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>from</span> IPython.testing.globalipapp <span style=color:#f92672>import</span> get_ipython
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> ip <span style=color:#f92672>=</span> get_ipython()
</span></span><span style=display:flex><span>In :
</span></span></code></pre></div><p>This will both create a shell object that you can reference with <code>ip</code> as well as turn that standard python shell into an ipython shell.</p><p>Second, we load the magic with <code>ip.magic('load_ext excelify')</code>. The <code>.magic()</code> method basically does the of prepending the argument provided with a <code>%</code> if you were in an ipython shell.</p><p>Third, we use the <code>run_line_magic()</code> method on the <code>ip</code> object to run our line magic. This method takes two arguments: the name of the magic function and the remaining of the arguments for that magic. If you were in an ipython shell, this is the equivalent of running <code>%{magic name} {magic arguments}</code>. Note: We can also load in your extension by running <code>ip.run_line_magic('load_ext', 'excelify')</code> instead of using the <code>magic()</code> method.</p><p>Now that we&rsquo;ve put all those parts together, we can use these methods to write more tests. There are other related methods if you&rsquo;re testing magics that might be helpful, including:</p><ul><li><code>run_cell_magic(magic_name, magic_args, cell)</code></li><li><code>run_line_magic(magic_name, magic_args)</code></li><li><code>magic(magic_line)</code></li></ul><p><strong>Potential Gotcha:</strong> If you want to run a magic that doesn&rsquo;t take any arguments, you&rsquo;ll need to pass an empty string for <code>magic_args</code> in the methods above (rather than leave the argument empty or <code>None</code>)</p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://www.peterbaumgartner.com/>Peter Baumgartner</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body><script data-goatcounter=https://peterbaumgartner.goatcounter.com/count async src=//gc.zgo.at/count.js></script></html>